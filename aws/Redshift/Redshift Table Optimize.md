## Redshift Table Optimize

> 2020.07.31

### Column Compression

Redshift作为列式存储一个重要的特性是数据压缩，所以对于原始表，我们首先考虑压缩选项。

不过Redshift不能调整已经存在表的压缩选项还是挺不方便的。一种解决方案是先unload表，然后再重新创建加载表。

> [Choosing a column compression type](https://docs.aws.amazon.com/redshift/latest/dg/t_Compressing_data_on_disk.html)

> You cannot change the compression encoding for a column after the table is created. You can specify the encoding for a column when it is added to a table using the ALTER TABLE command.

```
ALTER TABLE table-name ADD [ COLUMN ] column_name column_type ENCODE encoding-type
```

我们就采用新建表，然后再重命名回去的办法。

原始表结构如下：

```
 create table IF NOT EXISTS y20m06.device_results (
        id BIGINT identity(1, 1) PRIMARY KEY NOT NULL distkey,
        c_guid varchar(36) NULL,
        c_pid varchar(24) NULL,
        c_vid varchar(24) NULL,
        c_sid varchar(36) NULL,
        c_prod_ver varchar(12) NULL,
        c_sdk_ver varchar(12) NULL,
        gw_mac varchar(18) NULL,
        local_mac varchar(18) NULL,
        bssid varchar(18) NULL,
        s_guid varchar(36) NULL,
        region varchar(2) NULL,

        dev_ipv4 varchar(15) NULL,
        dev_ipv6 varchar(46) NULL,
        dev_mac varchar(18) NULL,
        client_mac varchar(18) NULL,
        is_extender_mac SMALLINT NULL,
        dev_brand varchar(128) NULL,
        brand_confidence char(1) NULL,
        category_id int NULL,
        category_class_id int NULL,
        category_confidence char(1) NULL,
        dev_model varchar(128) NULL,
        model_confidence char(1) NULL,
        hostname_1 varchar(128) NULL,
        hostname_1_confidence char(1) NULL,
        friendly_name varchar(256) NULL,
        friendly_name_rule SMALLINT NULL,
        req_url varchar(24) NULL,
        log_format varchar(4) NULL,
        log_date TIMESTAMP NULL,
        run_total_time FLOAT4 NULL,
        run_pattern_time FLOAT4 NULL,
        run_merge_time FLOAT4 NULL,
        run_mcb_time FLOAT4 NULL,
        run_cache_time FLOAT4 NULL,
        pattern_count int NULL,
        access_version varchar(8) NULL,
        core_version varchar(8) NULL,
        pattern_version varchar(8) NULL,
        s3_file_id int NULL REFERENCES public.s3_file_info (id)
        );
```

### ANALYZE COMPRESSION

AWS Redshift支持多种压缩方式，那么我们选中哪种压缩方式效果最好呢？这时候就可以使用ANALYZE COMPRESSION命令还产生各个列推荐的压缩方式。具体请参照[ANALYZE COMPRESSION](https://docs.aws.amazon.com/redshift/latest/dg/r_ANALYZE_COMPRESSION.html)，例如命令


```
analyse COMPRESSION  y20m06.device_results (id) COMPROWS 1000000000;
```

输出如下（删除多余行）：

| Table | Column | Encoding | Est\_reduction\_pct |
| :--- | :--- | :--- | :--- |
| device\_results | id | delta | 23.33 |
| device\_results | c\_guid | N/A | 0.00 |

### 使用压缩选项创建新的表

AWS推荐的压缩方式：

```
create table IF NOT EXISTS test.device_results_aws (
    id BIGINT GENERATED BY DEFAULT AS identity(1, 1) PRIMARY KEY NOT NULL encode DELTA  distkey,
    c_guid varchar(36) encode ZSTD,
    c_pid varchar(24) encode ZSTD,
    c_vid varchar(24) encode ZSTD,
    c_sid varchar(36) encode ZSTD,
    c_prod_ver varchar(12) encode ZSTD,
    c_sdk_ver varchar(12) encode ZSTD,
    gw_mac varchar(18) encode ZSTD,
    local_mac varchar(18) encode ZSTD,
    bssid varchar(18) encode ZSTD,
    s_guid varchar(36) encode ZSTD,
    region varchar(2) encode ZSTD,

    dev_ipv4 varchar(15) encode ZSTD,
    dev_ipv6 varchar(46) encode ZSTD,
    dev_mac varchar(18) encode ZSTD,
    client_mac varchar(18) encode ZSTD,
    is_extender_mac smallint encode ZSTD,
    dev_brand varchar(128) encode ZSTD,
    brand_confidence char encode ZSTD,
    category_id integer encode ZSTD,
    category_class_id integer encode ZSTD,
    category_confidence char encode ZSTD,
    dev_model varchar(128) encode ZSTD,
    model_confidence char encode ZSTD,
    hostname_1 varchar(128) encode ZSTD,
    hostname_1_confidence char encode ZSTD,
    friendly_name varchar(256) encode ZSTD,
    friendly_name_rule smallint encode ZSTD,
    req_url varchar(24) encode BYTEDICT,
    log_format varchar(4) encode ZSTD,
    log_date timestamp encode ZSTD,
    run_total_time real encode ZSTD,
    run_pattern_time real encode ZSTD,
    run_merge_time real encode ZSTD,
    run_mcb_time real encode ZSTD,
    run_cache_time real encode ZSTD,
    pattern_count integer encode az64,
    access_version varchar(8) encode ZSTD,
    core_version varchar(8) encode ZSTD,
    pattern_version varchar(8) encode ZSTD,
    s3_file_id integer encode ZSTD REFERENCES public.s3_file_info (id)
);
```

自己又调整两列的压缩方式：

```
create table IF NOT EXISTS test.device_results_own(
    id BIGINT GENERATED BY DEFAULT AS identity(1, 1) PRIMARY KEY NOT NULL encode DELTA  distkey,
    c_guid varchar(36) encode ZSTD,
    c_pid varchar(24) encode BYTEDICT,
    c_vid varchar(24) encode BYTEDICT,
    c_sid varchar(36) encode ZSTD,
    c_prod_ver varchar(12) encode BYTEDICT,
    c_sdk_ver varchar(12) encode BYTEDICT,
    gw_mac varchar(18) encode ZSTD,
    local_mac varchar(18) encode ZSTD,
    bssid varchar(18) encode ZSTD,
    s_guid varchar(36) encode ZSTD,
    region varchar(2) encode ZSTD,

    dev_ipv4 varchar(15) encode ZSTD,
    dev_ipv6 varchar(46) encode ZSTD,
    dev_mac varchar(18) encode ZSTD,
    client_mac varchar(18) encode ZSTD,
    is_extender_mac smallint encode ZSTD,
    dev_brand varchar(128) encode ZSTD,
    brand_confidence char encode ZSTD,
    category_id integer encode ZSTD,
    category_class_id integer encode ZSTD,
    category_confidence char encode ZSTD,
    dev_model varchar(128) encode ZSTD,
    model_confidence char encode ZSTD,
    hostname_1 varchar(128) encode ZSTD,
    hostname_1_confidence char encode ZSTD,
    friendly_name varchar(256) encode ZSTD,
    friendly_name_rule smallint encode ZSTD,
    req_url varchar(24) encode BYTEDICT,
    log_format varchar(4) encode ZSTD,
    log_date timestamp encode ZSTD,
    run_total_time real encode ZSTD,
    run_pattern_time real encode ZSTD,
    run_merge_time real encode ZSTD,
    run_mcb_time real encode ZSTD,
    run_cache_time real encode ZSTD,
    pattern_count integer encode ZSTD,
    access_version varchar(8) encode BYTEDICT,
    core_version varchar(8) encode BYTEDICT,
    pattern_version varchar(8) encode ZSTD,
    s3_file_id integer  encode ZSTD REFERENCES public.s3_file_info (id)
);
```

对比可以看到，新的测试表主键的自增方式定义与原表不同。这是因为Redshift不允许使用Insert命令为identity列显示的指定值（Copy命令除外）。

> You can't INSERT data setting the IDENTITY columns, but you can load data from S3 using COPY command.
> [How can I copy an IDENTITY field?](https://stackoverflow.com/questions/19822569/how-can-i-copy-an-identity-field)
> [Redshift Database Developer Guide - CREATE TABLE](https://docs.aws.amazon.com/redshift/latest/dg/r_CREATE_TABLE_NEW.html#identity-clause)

使用如下Insert命令插入原始表中数据，并查询各个表占用磁盘情况如下：

```
insert into test.device_results_own select * from y20m06.device_results;
insert into test.device_results_aws select * from y20m06.device_results;

SELECT  schema as table_schema, "table" as table_name, size as used_mb
FROM svv_table_info d order by size desc;
```

> [List tables by their size in Redshift](https://dataedo.com/kb/query/amazon-redshift/list-of-tables-by-their-size)


| table\_schema | table\_name | used\_mb |
| :--- | :--- | :--- |
| y20m06 | device\_results | 6806 |
| test | device\_results\_own | 4090 |
| test | device\_results\_aws | 3974 |

可以看到，AWS推荐的压缩方式可以得到更好的压缩比，测试表大约可以节省40%的存储空间。

### Choosing sort keys

目前查询Log的WEB页面查询较慢，考虑的一般查询场景为按用户MAC地址查询，所以添加一个sort key

```
create table IF NOT EXISTS test.device_results_aws_sort (
    id BIGINT GENERATED BY DEFAULT AS identity(1, 1) PRIMARY KEY NOT NULL encode DELTA  distkey,
    c_guid varchar(36) encode ZSTD,
    c_pid varchar(24) encode ZSTD,
    c_vid varchar(24) encode ZSTD,
    c_sid varchar(36) encode ZSTD,
    c_prod_ver varchar(12) encode ZSTD,
    c_sdk_ver varchar(12) encode ZSTD,
    gw_mac varchar(18) encode ZSTD,
    local_mac varchar(18) encode ZSTD,
    bssid varchar(18) encode ZSTD,
    s_guid varchar(36) encode ZSTD,
    region varchar(2) encode ZSTD,

    dev_ipv4 varchar(15) encode ZSTD,
    dev_ipv6 varchar(46) encode ZSTD,
    dev_mac varchar(18) encode ZSTD,
    client_mac varchar(18) encode ZSTD,
    is_extender_mac smallint encode ZSTD,
    dev_brand varchar(128) encode ZSTD,
    brand_confidence char encode ZSTD,
    category_id integer encode ZSTD,
    category_class_id integer encode ZSTD,
    category_confidence char encode ZSTD,
    dev_model varchar(128) encode ZSTD,
    model_confidence char encode ZSTD,
    hostname_1 varchar(128) encode ZSTD,
    hostname_1_confidence char encode ZSTD,
    friendly_name varchar(256) encode ZSTD,
    friendly_name_rule smallint encode ZSTD,
    req_url varchar(24) encode BYTEDICT,
    log_format varchar(4) encode ZSTD,
    log_date timestamp encode ZSTD,
    run_total_time real encode ZSTD,
    run_pattern_time real encode ZSTD,
    run_merge_time real encode ZSTD,
    run_mcb_time real encode ZSTD,
    run_cache_time real encode ZSTD,
    pattern_count integer encode az64,
    access_version varchar(8) encode ZSTD,
    core_version varchar(8) encode ZSTD,
    pattern_version varchar(8) encode ZSTD,
    s3_file_id integer encode ZSTD REFERENCES public.s3_file_info (id)
)
sortkey (dev_mac);
```

导入数据后，使用`analyse test.device_results_aws_sort;`语句重新生成表的统计信息。

查看各个表占用存储空间如下：

| table\_schema | table\_name | used\_mb |
| :--- | :--- | :--- |
| y20m06 | pattern\_info | 6768 |
| test | device\_results\_own | 4090 |
| test | device\_results\_aws | 3974 |
| test | device\_results\_aws\_sort | 3160 |

排序后，表的存储空间进一步变小，意外收获。同时按dev_mac查询性能得到显著提升。


测试另一张表，如下：

```
create table IF NOT EXISTS test.pattern_info (
id BIGINT GENERATED BY DEFAULT AS identity(1, 1) PRIMARY KEY NOT NULL encode DELTA distkey,
device_result_id BIGINT NOT NULL encode ZSTD REFERENCES test.device_results (id),
brand varchar(128) NULL encode ZSTD,
brand_from_list varchar(128) NULL encode ZSTD,
category_id int NULL encode ZSTD,
category_from_list varchar(128) NULL encode ZSTD,
model varchar(128) NULL encode ZSTD,
model_from_list varchar(128) NULL encode ZSTD,
pattern_id varchar(128) NULL encode ZSTD,
protocol varchar(64) NULL encode ZSTD,
script_id varchar(64) NULL encode ZSTD,
reference_pattern varchar(128) NULL encode ZSTD
)sortkey (device_result_id);
```

| table\_schema | table\_name | used\_mb |
| :--- | :--- | :--- |
|y20m06|pattern_info|6768|
|test|pattern_info|4626|

```
create table IF NOT EXISTS testtt.feedback_error(
id BIGINT GENERATED BY DEFAULT AS identity(1, 1) PRIMARY KEY NOT NULL encode DELTA distkey,
c_guid varchar(36) NULL encode ZSTD,
c_pid varchar(24) NULL encode ZSTD,
c_vid varchar(24) NULL encode ZSTD,
c_sid varchar(36) NULL encode ZSTD,
c_prod_ver varchar(12) NULL encode ZSTD,
c_sdk_ver varchar(12) NULL encode ZSTD,
gw_mac varchar(18) NULL encode ZSTD,
local_mac varchar(18) NULL encode ZSTD,
bssid varchar(18) NULL encode ZSTD,
s_guid varchar(36) NULL encode ZSTD,
region varchar(2) NULL encode ZSTD,

error_type varchar(32) NULL encode ZSTD,
gateway_ip_addr varchar(15) NULL encode ZSTD,
gateway_mac_addr varchar(18) NULL encode ZSTD,
local_dev_mac varchar(18) NULL encode ZSTD,
local_dev_ip varchar(15) NULL encode ZSTD,
scan_dev_ip varchar(15) NULL encode ZSTD,
scan_dev_mac varchar(18) NULL encode ZSTD,
nmap_exec_output varchar(128) NULL encode ZSTD,
error_content varchar(256) NULL encode ZSTD,

req_url varchar(24) NULL encode ZSTD,
log_date TIMESTAMP NULL encode ZSTD,
s3_file_id int NULL encode ZSTD REFERENCES public.s3_file_info (id)
);
```
