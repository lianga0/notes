### Amazon SNS 可靠性

From: [Amazon SNS 常见问题](https://aws.amazon.com/cn/sns/faqs/)

#### 问：我的数据发布到 Amazon SNS 后的持久性如何？

SNS 为接收的所有消息提供持久存储。接收到发布请求后，SNS 会在向发送者确认接收请求前跨多个可用区存储多个副本（到磁盘）。每个 AWS 区域都有多个相互隔离的位置，称为可用区。虽然罕见，但如果一个可用区出现故障，SNS 的运营和消息的持久性会继续保持而不会中断。 

#### 问：一条通知是否会包含多条消息？

不会，所有通知消息只包含一条发布的消息。

#### 问：每条消息会让订阅者收到多少次？

虽然大多数情况下每条消息只会向您的应用程序传送一次，但 Amazon SNS 的分布式特点和瞬变的网络条件可能导致订阅者端偶尔收到重复的消息。开发人员应将其应用程序设计为多次处理一条消息不会产生任何错误或不一致性。

#### 问：消息是否会按其发布的确切顺序传送给我？

Amazon SNS 服务将尝试按消息发布到主题的顺序传送发布者的消息。但是，网络问题可能会导致订阅者端的消息顺序错乱。

#### 问：是否可删除已发布的消息？

不可以，一旦将消息成功发布到主题，就无法再撤消。

#### 问：Amazon SNS 是否确保会将消息传送到订阅的终端节点？

在消息发布到主题后，Amazon SNS 将尝试向注册该主题的所有订阅者传送通知。由于潜在的 Internet 问题或电子邮件传送限制，有时通知可能无法成功送达 HTTP 或电子邮件终端节点。对于 HTTP，可使用 SNS 传输策略来控制重试模式（线性、几何、指数回退）、最大和最小重试延迟以及其他参数。如果成功处理所有发布的消息具有非常重要的意义，则开发人员还应将通知传送到 SQS 队列（除通过其他协议传送通知外）。

#### 问：如果订阅终端节点不可用，Amazon SNS 消息会如何？

系统会立即处理和传送发送至 SNS 的所有消息。如果初次尝试时无法成功传送消息，SNS 将实施一个 4 阶段重试策略：1) 无延迟重试；2) 最短延迟重试；3) 退避模型（线性或指数级）重试；4) 最长延迟重试。 

每个终端节点的策略有所不同，如下所示。

- SQS：如果 SQS 队列不可用，SNS 将立即重试 10 次，然后每 20 秒重试 100000 次，在将消息从 SNS 丢弃前的超过 23 天内总计重试 100010 次。
- Lambda：如果 Lambda 不可用，SNS 将相隔 1 秒重试 2 次，然后从 1 秒到 20 分钟内呈指数级退避重试 10 次，最后每 20 分钟重试 38 次，在将消息从 SNS 丢弃前的超过 13 个小时内总计重试 50 次。 
- HTTP/S：您可以针对与特定主题关联的 HTTP/S 终端节点设置传输策略。每个传输策略包含一个重试策略和一个限制策略。例如，重试策略可以指定重试的最短/最长延迟、延迟前重试次数和重试采用的退避类型（线性、指数级或算术）。  重试次数用尽后，系统会将消息从 SNS 中删除。限制策略由每个订阅每秒传送尝试的最大次数定义。  请参阅[设置 Amazon SNS 用于 HTTP/HTTPS 终端节点的传输重试策略](https://docs.aws.amazon.com/sns/latest/dg/DeliveryPolicies.html)，了解更多信息。
- 电子邮件：如果电子邮件终端节点不可用，SNS 将立即重试 1 次，间隔 10 秒再重试 1 次，然后从 10 秒到 5 分钟内线性退避重试 10 次，最后每 5 分钟重试 90 次，在将消息从 SNS 丢弃前的超过 7 个小时内总计重试 102 次。
- 移动推送：如果移动终端节点不可用，SNS 将立即重试 2 次，相隔 20 秒重试 5 次，然后从 20 秒到 20 分钟内呈指数级退避重试 31 次，最后每 20 分钟重试 12 次，在将消息从 SNS 丢弃前的超过 4 个小时内总计重试 50 次。
- SMS：如果 SMS 终端节点不可用，SNS 将相隔 1 秒重试 2 次，然后从 1 秒到 10 分钟内呈指数级退避重试 10 次，最后每 10 分钟重试 38 次，在将消息从 SNS 丢弃前的超过 6 个小时内总计重试 50 次。

